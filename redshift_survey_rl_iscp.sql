
-- query result from a single survey
select
sas.surveyid,
a.adid as originalAdId,
sas.adId as surveyAdId,
a.templatetype as format,
substring(a.name, 2,2) as market,
a.starttime as startTime,
a.endtime as endTime,
sas.created_at as surveyResponceTime,
sas.uid as uid,
sas.answerSetId as answerSetId,
sa.answerId as answerId,
sa.questionId as questionId,
sq_l.text as questionText,
sa.optionId as optionId,
sol.text as optionText,
sas.iscomplete as iscomplete,
sas.isRefGroup as isRefGroup
from public.surveydb_SurveyAnswerSets sas
JOIN public.surveydb_SurveyAnswers sa
on sa.answersetid=sas.answersetid
join public.surveydb_Surveys_OriginalAds so
on sas.surveyid=so.surveyid
join public.novadb_online_ad a
on so.originaladid=a.adid
JOIN public.surveydb_SurveyOptions_Languages sol on sa.optionId=sol.optionId
JOIN public.surveydb_SurveyQuestions_Languages sq_l on sq_l.questionid=sa.questionId
where sol.languageId='en-GB'
and sq_l.languageid='en-GB'
and sas.surveyid in (457);




FROM public.rl2_delivery d
INNER JOIN public.rl2_impression i ON (d.deliveryid=i.deliveryid)
FULL OUTER JOIN  public.inscreen_currentposition c ON (c.deliveryid=d.deliveryid AND c.adid in (38768))



-- find suitable survey candidates between nov 2015 and feb 2016
select
sas.surveyid,
a.adid as originalAdId,
sas.adId as surveyAdId,
a.templatetype as format,
substring(a.name, 2,2) as market,
a.starttime as startTime,
a.endtime as endTime,
count(distinct sas.answersetid) as numResponce
from public.surveydb_SurveyAnswerSets sas
JOIN public.surveydb_SurveyAnswers sa
on sa.answersetid=sas.answersetid
join public.surveydb_Surveys_OriginalAds so
on sas.surveyid=so.surveyid
join public.novadb_online_ad a
on so.originaladid=a.adid
JOIN public.surveydb_SurveyOptions_Languages sol on sa.optionId=sol.optionId
JOIN public.surveydb_SurveyQuestions_Languages sq_l on sq_l.questionid=sa.questionId
where sol.languageId='en-GB'
and sq_l.languageid='en-GB'
and a.starttime::date>='2015-11-01'
and a.endtime::date<='2016-02-29'
and sas.created_at::date <='2016-02-29'
and a.templatetype in ('swipe','takeover')
and substring(a.name, 2,2) <> 'AS'
group by 1,2,3,4,5,6,7
order by 1,2;

-- check num of interviews from each survey
select
sas.surveyid,
count(distinct sas.answersetid) as numResponce
from public.surveydb_SurveyAnswerSets sas
JOIN public.surveydb_SurveyAnswers sa
on sa.answersetid=sas.answersetid
join public.surveydb_Surveys_OriginalAds so
on sas.surveyid=so.surveyid
join public.novadb_online_ad a
on so.originaladid=a.adid
JOIN public.surveydb_SurveyOptions_Languages sol on sa.optionId=sol.optionId
JOIN public.surveydb_SurveyQuestions_Languages sq_l on sq_l.questionid=sa.questionId
where sol.languageId='en-GB'
and sq_l.languageid='en-GB'
and a.starttime::date>='2015-11-01'
and a.endtime::date<='2016-02-29'
and sas.created_at::date <='2016-02-29'
and a.templatetype in ('swipe','takeover')
and substring(a.name, 2,2) <> 'AS'
group by 1
order by 1;

-- survey join requestlog
select
sas.surveyid,
a.adid as originalAdId,
a.templatetype as format,
substring(a.name, 2,2) as market,
sas.uid as uid,
sas.answerSetId as answerSetId,
sa.answerId as answerId,
sa.questionId as questionId,
sq_l.text as questionText,
sa.optionId as optionId,
sol.text as optionText,
sas.iscomplete as iscomplete,
sas.isRefGroup as isRefGroup,
COUNT(DISTINCT CASE WHEN i.impressiontype = 0 THEN i.impressionid END) AS deliveredImp,
COUNT(DISTINCT CASE WHEN i.impressiontype = 1 THEN i.impressionid END) AS viewableImp
from public.surveydb_SurveyAnswerSets sas
INNER JOIN public.surveydb_SurveyAnswers sa
on sa.answersetid=sas.answersetid
INNER JOIN public.surveydb_Surveys_OriginalAds so
on sas.surveyid=so.surveyid
INNER JOIN public.novadb_online_ad a
on so.originaladid=a.adid
INNER JOIN public.surveydb_SurveyOptions_Languages sol on sa.optionId=sol.optionId
INNER JOIN public.surveydb_SurveyQuestions_Languages sq_l on sq_l.questionid=sa.questionId
INNER JOIN rl2.delivery_partition_201511 d ON d.user_uid=sas.uid
INNER JOIN rl2.impression_partition_201511 i ON (d.deliveryid=i.deliveryid)
where sol.languageId='en-GB'
and sq_l.languageid='en-GB'
and a.starttime::date>='2015-11-01'
and a.endtime::date<='2016-02-29'
and d.timestamp::date>='2015-11-01'
and d.timestamp::date<='2016-02-29'
and i.timestamp::date>='2015-11-01'
and i.timestamp::date<='2016-02-29'
and sq_l.questionid in (4,86)
and sas.surveyid in (305,435,452,498,482,519,291,339,338,352,355,325,324,446,337,375,411,415,431,437,320,517,520,336,308,351,321,356,370,385,396,400,516,395,433,310,378,398,409,420,424,447,428,521,322,349,377,390,397,402,425,440,445,315,394,359,391,392,451,454,485,501,487,422,438,457,518,326,503,432,334,373,388,401,419,441,512,514,429,354,340,423,408,444,481,488,494,528,316,412,430,427,459,504,511,335,449,448,455,453,333,317,386,403,443,410
)
and so.originaladid in (38635,36776,36100,37061,35335,37644,36994,36951,37864,37890,38169,37613,38071,38364,38597,38582,33529,38609,39076,39098,38355,39287,39497,40061,36897,39598,38482,37126,35213,36430,37612,37938,37940,38361,38012,38586,39441,39492,39498,38028,38682,36687,37286,36693,38167,35979,37939,38368,38366,38341,37619,38768,37252,38583,38178,39488,39494,39308,36772,36775,33647,38360,35031,38568,39188,38110,39443,39473,39490,39491,39640,37017,38770,39280,35270,36540,35740,35927,37273,37639,38372,38290,38687,39124,39439,39338,38027,38082,39192,35015,37207,38363,35710,38972,37468,39288,39440,39495,39061,39530,35772,36118,36481,35012,38137,37689,37690,38393,35912,38359,36229,38358,38940,39211,39442,39474,39499,39170,39791,39979,38565,37205,38384,38387,38370,38369,37016,36773,37125,38658,38737,39153,35773,36432,35471,37235,38013,37272,38556,37782,39026,39126,39980,38016,38864,37397,38574,35917,37276,36563,38371,38989,38798,39368,37018,35857,36431,35928,36627,38362,38080,38291,39435,34867,37263,36752,36148,37306,36720,38020,36562,37937,37941,38331,38381,38385,38367,38365,38584,38585,34727,37628,39125,39396,39493,39531,39985,40062
)
and d.ad_adid in (38635,36776,36100,37061,35335,37644,36994,36951,37864,37890,38169,37613,38071,38364,38597,38582,33529,38609,39076,39098,38355,39287,39497,40061,36897,39598,38482,37126,35213,36430,37612,37938,37940,38361,38012,38586,39441,39492,39498,38028,38682,36687,37286,36693,38167,35979,37939,38368,38366,38341,37619,38768,37252,38583,38178,39488,39494,39308,36772,36775,33647,38360,35031,38568,39188,38110,39443,39473,39490,39491,39640,37017,38770,39280,35270,36540,35740,35927,37273,37639,38372,38290,38687,39124,39439,39338,38027,38082,39192,35015,37207,38363,35710,38972,37468,39288,39440,39495,39061,39530,35772,36118,36481,35012,38137,37689,37690,38393,35912,38359,36229,38358,38940,39211,39442,39474,39499,39170,39791,39979,38565,37205,38384,38387,38370,38369,37016,36773,37125,38658,38737,39153,35773,36432,35471,37235,38013,37272,38556,37782,39026,39126,39980,38016,38864,37397,38574,35917,37276,36563,38371,38989,38798,39368,37018,35857,36431,35928,36627,38362,38080,38291,39435,34867,37263,36752,36148,37306,36720,38020,36562,37937,37941,38331,38381,38385,38367,38365,38584,38585,34727,37628,39125,39396,39493,39531,39985,40062
)
and sas.created_at >= i.timestamp
and d.valid=1
group by 1,2,3,4,5,6,7,8,9,10,11,12,13
order by 1
;



-- survey join requestlog join inscreenlog 1 month data
select
sas.surveyid,
a.adid as originalAdId,
a.templatetype as format,
substring(a.name, 2,2) as market,
sas.uid as uid,
sas.answerSetId as answerSetId,
sa.answerId as answerId,
sa.questionId as questionId,
sq_l.text as questionText,
sa.optionId as optionId,
sol.text as optionText,
sas.iscomplete as iscomplete,
sas.isRefGroup as isRefGroup,
COUNT(DISTINCT CASE WHEN i.impressiontype = 0 THEN i.impressionid END) AS deliveredImp,
COUNT(DISTINCT CASE WHEN i.impressiontype = 1 THEN i.impressionid END) AS viewableImp,
COUNT(DISTINCT ic.deliveryid) as viewableImp_ic,
SUM(ic.vt) as totalViewTime
from public.surveydb_SurveyAnswerSets sas
INNER JOIN public.surveydb_SurveyAnswers sa
on sa.answersetid=sas.answersetid
INNER JOIN public.surveydb_Surveys_OriginalAds so
on sas.surveyid=so.surveyid
INNER JOIN public.novadb_online_ad a
on so.originaladid=a.adid
INNER JOIN public.surveydb_SurveyOptions_Languages sol on sa.optionId=sol.optionId
INNER JOIN public.surveydb_SurveyQuestions_Languages sq_l on sq_l.questionid=sa.questionId
INNER JOIN rl2.delivery_partition_201511 d ON d.user_uid=sas.uid
INNER JOIN rl2.impression_partition_201511 i ON (d.deliveryid=i.deliveryid)
INNER JOIN
(select c.deliveryid, sum(c.vt) as vt
from
(select deliveryid,
sizepct,
sum(timems) as vt
from
inscreen.currentposition_partition_201511
where adid in (38635,36776,36100,37061,35335,37644,36994,36951,37864,37890,38169,37613,38071,38364,38597,38582,33529,38609,39076,39098,38355,39287,39497,40061,36897,39598,38482,37126,35213,36430,37612,37938,37940,38361,38012,38586,39441,39492,39498,38028,38682,36687,37286,36693,38167,35979,37939,38368,38366,38341,37619,38768,37252,38583,38178,39488,39494,39308,36772,36775,33647,38360,35031,38568,39188,38110,39443,39473,39490,39491,39640,37017,38770,39280,35270,36540,35740,35927,37273,37639,38372,38290,38687,39124,39439,39338,38027,38082,39192,35015,37207,38363,35710,38972,37468,39288,39440,39495,39061,39530,35772,36118,36481,35012,38137,37689,37690,38393,35912,38359,36229,38358,38940,39211,39442,39474,39499,39170,39791,39979,38565,37205,38384,38387,38370,38369,37016,36773,37125,38658,38737,39153,35773,36432,35471,37235,38013,37272,38556,37782,39026,39126,39980,38016,38864,37397,38574,35917,37276,36563,38371,38989,38798,39368,37018,35857,36431,35928,36627,38362,38080,38291,39435,34867,37263,36752,36148,37306,36720,38020,36562,37937,37941,38331,38381,38385,38367,38365,38584,38585,34727,37628,39125,39396,39493,39531,39985,40062
)
and sizepct>=30
group by 1,2 having sum(timems)>=300) c
group by 1) ic
ON (ic.deliveryid=d.deliveryid)
where sol.languageId='en-GB'
and sq_l.languageid='en-GB'
and sq_l.questionid in (4,86)
and sas.surveyid in (305,435,452,498,482,519,291,339,338,352,355,325,324,446,337,375,411,415,431,437,320,517,520,336,308,351,321,356,370,385,396,400,516,395,433,310,378,398,409,420,424,447,428,521,322,349,377,390,397,402,425,440,445,315,394,359,391,392,451,454,485,501,487,422,438,457,518,326,503,432,334,373,388,401,419,441,512,514,429,354,340,423,408,444,481,488,494,528,316,412,430,427,459,504,511,335,449,448,455,453,333,317,386,403,443,410
)
and so.originaladid in (38635,36776,36100,37061,35335,37644,36994,36951,37864,37890,38169,37613,38071,38364,38597,38582,33529,38609,39076,39098,38355,39287,39497,40061,36897,39598,38482,37126,35213,36430,37612,37938,37940,38361,38012,38586,39441,39492,39498,38028,38682,36687,37286,36693,38167,35979,37939,38368,38366,38341,37619,38768,37252,38583,38178,39488,39494,39308,36772,36775,33647,38360,35031,38568,39188,38110,39443,39473,39490,39491,39640,37017,38770,39280,35270,36540,35740,35927,37273,37639,38372,38290,38687,39124,39439,39338,38027,38082,39192,35015,37207,38363,35710,38972,37468,39288,39440,39495,39061,39530,35772,36118,36481,35012,38137,37689,37690,38393,35912,38359,36229,38358,38940,39211,39442,39474,39499,39170,39791,39979,38565,37205,38384,38387,38370,38369,37016,36773,37125,38658,38737,39153,35773,36432,35471,37235,38013,37272,38556,37782,39026,39126,39980,38016,38864,37397,38574,35917,37276,36563,38371,38989,38798,39368,37018,35857,36431,35928,36627,38362,38080,38291,39435,34867,37263,36752,36148,37306,36720,38020,36562,37937,37941,38331,38381,38385,38367,38365,38584,38585,34727,37628,39125,39396,39493,39531,39985,40062
)
and d.ad_adid in (38635,36776,36100,37061,35335,37644,36994,36951,37864,37890,38169,37613,38071,38364,38597,38582,33529,38609,39076,39098,38355,39287,39497,40061,36897,39598,38482,37126,35213,36430,37612,37938,37940,38361,38012,38586,39441,39492,39498,38028,38682,36687,37286,36693,38167,35979,37939,38368,38366,38341,37619,38768,37252,38583,38178,39488,39494,39308,36772,36775,33647,38360,35031,38568,39188,38110,39443,39473,39490,39491,39640,37017,38770,39280,35270,36540,35740,35927,37273,37639,38372,38290,38687,39124,39439,39338,38027,38082,39192,35015,37207,38363,35710,38972,37468,39288,39440,39495,39061,39530,35772,36118,36481,35012,38137,37689,37690,38393,35912,38359,36229,38358,38940,39211,39442,39474,39499,39170,39791,39979,38565,37205,38384,38387,38370,38369,37016,36773,37125,38658,38737,39153,35773,36432,35471,37235,38013,37272,38556,37782,39026,39126,39980,38016,38864,37397,38574,35917,37276,36563,38371,38989,38798,39368,37018,35857,36431,35928,36627,38362,38080,38291,39435,34867,37263,36752,36148,37306,36720,38020,36562,37937,37941,38331,38381,38385,38367,38365,38584,38585,34727,37628,39125,39396,39493,39531,39985,40062
)
and sas.created_at >= i.timestamp
and d.valid=1
group by 1,2,3,4,5,6,7,8,9,10,11,12,13
order by 1
;



-- survey join requestlog join inscreenlog 4 month data
select
sas.surveyid,
a.adid as originalAdId,
a.templatetype as format,
substring(a.name, 2,2) as market,
sas.uid as uid,
sas.answerSetId as answerSetId,
sa.answerId as answerId,
sa.questionId as questionId,
sq_l.text as questionText,
sa.optionId as optionId,
sol.text as optionText,
sas.iscomplete as iscomplete,
sas.isRefGroup as isRefGroup,
COUNT(DISTINCT CASE WHEN i.impressiontype = 0 THEN i.impressionid END) AS deliveredImp,
COUNT(DISTINCT CASE WHEN i.impressiontype = 1 THEN i.impressionid END) AS viewableImp,
COUNT(DISTINCT ic.deliveryid) as viewableImp_ic,
SUM(ic.vt) as totalViewTime
from public.surveydb_SurveyAnswerSets sas
INNER JOIN public.surveydb_SurveyAnswers sa
on sa.answersetid=sas.answersetid
INNER JOIN public.surveydb_Surveys_OriginalAds so
on sas.surveyid=so.surveyid
INNER JOIN public.novadb_online_ad a
on so.originaladid=a.adid
INNER JOIN public.surveydb_SurveyOptions_Languages sol on sa.optionId=sol.optionId
INNER JOIN public.surveydb_SurveyQuestions_Languages sq_l on sq_l.questionid=sa.questionId
INNER JOIN
(select * from rl2.delivery_partition_201511 where ad_adid in (38635,36776,36100,37061,35335,37644,36994,36951,37864,37890,38169,37613,38071,38364,38597,38582,33529,38609,39076,39098,38355,39287,39497,40061,36897,39598,38482,37126,35213,36430,37612,37938,37940,38361,38012,38586,39441,39492,39498,38028,38682,36687,37286,36693,38167,35979,37939,38368,38366,38341,37619,38768,37252,38583,38178,39488,39494,39308,36772,36775,33647,38360,35031,38568,39188,38110,39443,39473,39490,39491,39640,37017,38770,39280,35270,36540,35740,35927,37273,37639,38372,38290,38687,39124,39439,39338,38027,38082,39192,35015,37207,38363,35710,38972,37468,39288,39440,39495,39061,39530,35772,36118,36481,35012,38137,37689,37690,38393,35912,38359,36229,38358,38940,39211,39442,39474,39499,39170,39791,39979,38565,37205,38384,38387,38370,38369,37016,36773,37125,38658,38737,39153,35773,36432,35471,37235,38013,37272,38556,37782,39026,39126,39980,38016,38864,37397,38574,35917,37276,36563,38371,38989,38798,39368,37018,35857,36431,35928,36627,38362,38080,38291,39435,34867,37263,36752,36148,37306,36720,38020,36562,37937,37941,38331,38381,38385,38367,38365,38584,38585,34727,37628,39125,39396,39493,39531,39985,40062)
union all
select * from rl2.delivery_partition_201512 where ad_adid in (38635,36776,36100,37061,35335,37644,36994,36951,37864,37890,38169,37613,38071,38364,38597,38582,33529,38609,39076,39098,38355,39287,39497,40061,36897,39598,38482,37126,35213,36430,37612,37938,37940,38361,38012,38586,39441,39492,39498,38028,38682,36687,37286,36693,38167,35979,37939,38368,38366,38341,37619,38768,37252,38583,38178,39488,39494,39308,36772,36775,33647,38360,35031,38568,39188,38110,39443,39473,39490,39491,39640,37017,38770,39280,35270,36540,35740,35927,37273,37639,38372,38290,38687,39124,39439,39338,38027,38082,39192,35015,37207,38363,35710,38972,37468,39288,39440,39495,39061,39530,35772,36118,36481,35012,38137,37689,37690,38393,35912,38359,36229,38358,38940,39211,39442,39474,39499,39170,39791,39979,38565,37205,38384,38387,38370,38369,37016,36773,37125,38658,38737,39153,35773,36432,35471,37235,38013,37272,38556,37782,39026,39126,39980,38016,38864,37397,38574,35917,37276,36563,38371,38989,38798,39368,37018,35857,36431,35928,36627,38362,38080,38291,39435,34867,37263,36752,36148,37306,36720,38020,36562,37937,37941,38331,38381,38385,38367,38365,38584,38585,34727,37628,39125,39396,39493,39531,39985,40062)
union all
select * from rl2.delivery_partition_201601 where ad_adid in (38635,36776,36100,37061,35335,37644,36994,36951,37864,37890,38169,37613,38071,38364,38597,38582,33529,38609,39076,39098,38355,39287,39497,40061,36897,39598,38482,37126,35213,36430,37612,37938,37940,38361,38012,38586,39441,39492,39498,38028,38682,36687,37286,36693,38167,35979,37939,38368,38366,38341,37619,38768,37252,38583,38178,39488,39494,39308,36772,36775,33647,38360,35031,38568,39188,38110,39443,39473,39490,39491,39640,37017,38770,39280,35270,36540,35740,35927,37273,37639,38372,38290,38687,39124,39439,39338,38027,38082,39192,35015,37207,38363,35710,38972,37468,39288,39440,39495,39061,39530,35772,36118,36481,35012,38137,37689,37690,38393,35912,38359,36229,38358,38940,39211,39442,39474,39499,39170,39791,39979,38565,37205,38384,38387,38370,38369,37016,36773,37125,38658,38737,39153,35773,36432,35471,37235,38013,37272,38556,37782,39026,39126,39980,38016,38864,37397,38574,35917,37276,36563,38371,38989,38798,39368,37018,35857,36431,35928,36627,38362,38080,38291,39435,34867,37263,36752,36148,37306,36720,38020,36562,37937,37941,38331,38381,38385,38367,38365,38584,38585,34727,37628,39125,39396,39493,39531,39985,40062)
union all
select * from rl2.delivery_partition_201602 where ad_adid in (38635,36776,36100,37061,35335,37644,36994,36951,37864,37890,38169,37613,38071,38364,38597,38582,33529,38609,39076,39098,38355,39287,39497,40061,36897,39598,38482,37126,35213,36430,37612,37938,37940,38361,38012,38586,39441,39492,39498,38028,38682,36687,37286,36693,38167,35979,37939,38368,38366,38341,37619,38768,37252,38583,38178,39488,39494,39308,36772,36775,33647,38360,35031,38568,39188,38110,39443,39473,39490,39491,39640,37017,38770,39280,35270,36540,35740,35927,37273,37639,38372,38290,38687,39124,39439,39338,38027,38082,39192,35015,37207,38363,35710,38972,37468,39288,39440,39495,39061,39530,35772,36118,36481,35012,38137,37689,37690,38393,35912,38359,36229,38358,38940,39211,39442,39474,39499,39170,39791,39979,38565,37205,38384,38387,38370,38369,37016,36773,37125,38658,38737,39153,35773,36432,35471,37235,38013,37272,38556,37782,39026,39126,39980,38016,38864,37397,38574,35917,37276,36563,38371,38989,38798,39368,37018,35857,36431,35928,36627,38362,38080,38291,39435,34867,37263,36752,36148,37306,36720,38020,36562,37937,37941,38331,38381,38385,38367,38365,38584,38585,34727,37628,39125,39396,39493,39531,39985,40062)
) d
ON d.user_uid=sas.uid
INNER JOIN
(select * from rl2.impression_partition_201511
union all
select * from rl2.impression_partition_201512
union all
select * from rl2.impression_partition_201601
union all
select * from rl2.impression_partition_201602
) i
ON (d.deliveryid=i.deliveryid)
INNER JOIN
(select c.deliveryid, sum(c.vt) as vt
from
(select deliveryid,
sizepct,
sum(timems) as vt
from
(
select * from inscreen.currentposition_partition_201511 where adid in (38635,36776,36100,37061,35335,37644,36994,36951,37864,37890,38169,37613,38071,38364,38597,38582,33529,38609,39076,39098,38355,39287,39497,40061,36897,39598,38482,37126,35213,36430,37612,37938,37940,38361,38012,38586,39441,39492,39498,38028,38682,36687,37286,36693,38167,35979,37939,38368,38366,38341,37619,38768,37252,38583,38178,39488,39494,39308,36772,36775,33647,38360,35031,38568,39188,38110,39443,39473,39490,39491,39640,37017,38770,39280,35270,36540,35740,35927,37273,37639,38372,38290,38687,39124,39439,39338,38027,38082,39192,35015,37207,38363,35710,38972,37468,39288,39440,39495,39061,39530,35772,36118,36481,35012,38137,37689,37690,38393,35912,38359,36229,38358,38940,39211,39442,39474,39499,39170,39791,39979,38565,37205,38384,38387,38370,38369,37016,36773,37125,38658,38737,39153,35773,36432,35471,37235,38013,37272,38556,37782,39026,39126,39980,38016,38864,37397,38574,35917,37276,36563,38371,38989,38798,39368,37018,35857,36431,35928,36627,38362,38080,38291,39435,34867,37263,36752,36148,37306,36720,38020,36562,37937,37941,38331,38381,38385,38367,38365,38584,38585,34727,37628,39125,39396,39493,39531,39985,40062)
union all
select * from inscreen.currentposition_partition_201512 where adid in (38635,36776,36100,37061,35335,37644,36994,36951,37864,37890,38169,37613,38071,38364,38597,38582,33529,38609,39076,39098,38355,39287,39497,40061,36897,39598,38482,37126,35213,36430,37612,37938,37940,38361,38012,38586,39441,39492,39498,38028,38682,36687,37286,36693,38167,35979,37939,38368,38366,38341,37619,38768,37252,38583,38178,39488,39494,39308,36772,36775,33647,38360,35031,38568,39188,38110,39443,39473,39490,39491,39640,37017,38770,39280,35270,36540,35740,35927,37273,37639,38372,38290,38687,39124,39439,39338,38027,38082,39192,35015,37207,38363,35710,38972,37468,39288,39440,39495,39061,39530,35772,36118,36481,35012,38137,37689,37690,38393,35912,38359,36229,38358,38940,39211,39442,39474,39499,39170,39791,39979,38565,37205,38384,38387,38370,38369,37016,36773,37125,38658,38737,39153,35773,36432,35471,37235,38013,37272,38556,37782,39026,39126,39980,38016,38864,37397,38574,35917,37276,36563,38371,38989,38798,39368,37018,35857,36431,35928,36627,38362,38080,38291,39435,34867,37263,36752,36148,37306,36720,38020,36562,37937,37941,38331,38381,38385,38367,38365,38584,38585,34727,37628,39125,39396,39493,39531,39985,40062)
union all
select * from inscreen.currentposition_partition_201601 where adid in (38635,36776,36100,37061,35335,37644,36994,36951,37864,37890,38169,37613,38071,38364,38597,38582,33529,38609,39076,39098,38355,39287,39497,40061,36897,39598,38482,37126,35213,36430,37612,37938,37940,38361,38012,38586,39441,39492,39498,38028,38682,36687,37286,36693,38167,35979,37939,38368,38366,38341,37619,38768,37252,38583,38178,39488,39494,39308,36772,36775,33647,38360,35031,38568,39188,38110,39443,39473,39490,39491,39640,37017,38770,39280,35270,36540,35740,35927,37273,37639,38372,38290,38687,39124,39439,39338,38027,38082,39192,35015,37207,38363,35710,38972,37468,39288,39440,39495,39061,39530,35772,36118,36481,35012,38137,37689,37690,38393,35912,38359,36229,38358,38940,39211,39442,39474,39499,39170,39791,39979,38565,37205,38384,38387,38370,38369,37016,36773,37125,38658,38737,39153,35773,36432,35471,37235,38013,37272,38556,37782,39026,39126,39980,38016,38864,37397,38574,35917,37276,36563,38371,38989,38798,39368,37018,35857,36431,35928,36627,38362,38080,38291,39435,34867,37263,36752,36148,37306,36720,38020,36562,37937,37941,38331,38381,38385,38367,38365,38584,38585,34727,37628,39125,39396,39493,39531,39985,40062)
union all
select * from inscreen.currentposition_partition_201602 where adid in (38635,36776,36100,37061,35335,37644,36994,36951,37864,37890,38169,37613,38071,38364,38597,38582,33529,38609,39076,39098,38355,39287,39497,40061,36897,39598,38482,37126,35213,36430,37612,37938,37940,38361,38012,38586,39441,39492,39498,38028,38682,36687,37286,36693,38167,35979,37939,38368,38366,38341,37619,38768,37252,38583,38178,39488,39494,39308,36772,36775,33647,38360,35031,38568,39188,38110,39443,39473,39490,39491,39640,37017,38770,39280,35270,36540,35740,35927,37273,37639,38372,38290,38687,39124,39439,39338,38027,38082,39192,35015,37207,38363,35710,38972,37468,39288,39440,39495,39061,39530,35772,36118,36481,35012,38137,37689,37690,38393,35912,38359,36229,38358,38940,39211,39442,39474,39499,39170,39791,39979,38565,37205,38384,38387,38370,38369,37016,36773,37125,38658,38737,39153,35773,36432,35471,37235,38013,37272,38556,37782,39026,39126,39980,38016,38864,37397,38574,35917,37276,36563,38371,38989,38798,39368,37018,35857,36431,35928,36627,38362,38080,38291,39435,34867,37263,36752,36148,37306,36720,38020,36562,37937,37941,38331,38381,38385,38367,38365,38584,38585,34727,37628,39125,39396,39493,39531,39985,40062)
)
where
sizepct>=30
group by 1,2 having sum(timems)>=300) c
group by 1) ic
ON (ic.deliveryid=d.deliveryid)
where sol.languageId='en-GB'
and sq_l.languageid='en-GB'
and sq_l.questionid in (4,86)
and sas.surveyid in (305,435,452,498,482,519,291,339,338,352,355,325,324,446,337,375,411,415,431,437,320,517,520,336,308,351,321,356,370,385,396,400,516,395,433,310,378,398,409,420,424,447,428,521,322,349,377,390,397,402,425,440,445,315,394,359,391,392,451,454,485,501,487,422,438,457,518,326,503,432,334,373,388,401,419,441,512,514,429,354,340,423,408,444,481,488,494,528,316,412,430,427,459,504,511,335,449,448,455,453,333,317,386,403,443,410)
and so.originaladid in (38635,36776,36100,37061,35335,37644,36994,36951,37864,37890,38169,37613,38071,38364,38597,38582,33529,38609,39076,39098,38355,39287,39497,40061,36897,39598,38482,37126,35213,36430,37612,37938,37940,38361,38012,38586,39441,39492,39498,38028,38682,36687,37286,36693,38167,35979,37939,38368,38366,38341,37619,38768,37252,38583,38178,39488,39494,39308,36772,36775,33647,38360,35031,38568,39188,38110,39443,39473,39490,39491,39640,37017,38770,39280,35270,36540,35740,35927,37273,37639,38372,38290,38687,39124,39439,39338,38027,38082,39192,35015,37207,38363,35710,38972,37468,39288,39440,39495,39061,39530,35772,36118,36481,35012,38137,37689,37690,38393,35912,38359,36229,38358,38940,39211,39442,39474,39499,39170,39791,39979,38565,37205,38384,38387,38370,38369,37016,36773,37125,38658,38737,39153,35773,36432,35471,37235,38013,37272,38556,37782,39026,39126,39980,38016,38864,37397,38574,35917,37276,36563,38371,38989,38798,39368,37018,35857,36431,35928,36627,38362,38080,38291,39435,34867,37263,36752,36148,37306,36720,38020,36562,37937,37941,38331,38381,38385,38367,38365,38584,38585,34727,37628,39125,39396,39493,39531,39985,40062)
and sas.created_at >= i.timestamp
and d.valid=1
group by 1,2,3,4,5,6,7,8,9,10,11,12,13
order by 1
;
